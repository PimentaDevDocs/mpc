<!DOCTYPE html>
<html lang="pt-pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minhoca Poker Club</title>
    <style>
        :root {
            --red: #dc3545;
            --green: #28a745;
            --blue: #007bff;
            --dark: #343a40;
            --gray: #6c757d;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 850px;
            margin: 10px auto;
            background: #f0f2f5;
            padding: 10px;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        /* Timers */
        .timers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .timer-card {
            background: var(--dark);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .timer-display {
            font-size: 2rem;
            font-family: monospace;
            color: #00ff00;
            margin: 5px 0;
        }

        @keyframes blinker {
            50% {
                background-color: var(--red);
            }
        }

        .timer-card.alarm-active {
            animation: blinker 0.4s linear infinite;
        }

        /* Interface Mobile */
        .input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            padding: 10px;
        }

        .btn-add {
            background: var(--blue);
            color: white;
        }

        .btn-minus {
            background: var(--red);
            color: white;
            width: 35px;
        }

        .btn-plus {
            background: var(--blue);
            color: white;
            width: 35px;
        }

        .btn-remove {
            background: var(--red);
            color: white;
            font-size: 0.8em;
        }

        .btn-remove:disabled {
            background: #ccc;
            opacity: 0.5;
        }

        .btn-finish {
            background: var(--green);
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            margin-top: 15px;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background: #fff;
            margin-bottom: 5px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .qty {
            font-weight: bold;
            min-width: 25px;
            text-align: center;
        }

        .result-box {
            background: #e7f3ff;
            border-left: 5px solid var(--blue);
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
        }

        .history-card {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
    </style>
</head>

<body>

    <div class="timers-grid">
        <div class="timer-card" id="t10">
            <div class="timer-display">10:00</div>
            <button onclick="toggleTimer('t10', 600)" style="background:var(--green); color:white">Play/Pausa</button>
            <button onclick="resetIndividual('t10', 600)" style="background:var(--gray); color:white">Reset</button>
        </div>
        <div class="timer-card" id="t7">
            <div class="timer-display">07:00</div>
            <button onclick="toggleTimer('t7', 420)" style="background:var(--green); color:white">Play/Pausa</button>
            <button onclick="resetIndividual('t7', 420)" style="background:var(--gray); color:white">Reset</button>
        </div>
        <div class="timer-card" id="t2">
            <div class="timer-display">02:00</div>
            <button onclick="toggleTimer('t2', 120)" style="background:var(--green); color:white">Play/Pausa</button>
            <button onclick="resetIndividual('t2', 120)" style="background:var(--gray); color:white">Reset</button>
        </div>
    </div>

    <div class="container">
        <div class="input-row">
            <input type="text" id="nomeInput" placeholder="Jogador..." autocomplete="off">
            <button class="btn-add" onclick="add()">Add</button>
        </div>
        <ul id="lista"></ul>
        <div id="calculoAtual" style="display:none">
            <hr>
            <p>Total Entradas: <strong id="totalTxt">0</strong></p>
            <div id="dist"></div>
            <button class="btn-finish" onclick="finalizarPartida()">Finalizar Partida</button>
        </div>
    </div>

    <div class="container" id="historicoSection" style="display:none">
        <div style="display:flex; justify-content:space-between;">
            <h3>Histórico</h3>
            <button onclick="limparHistorico()"
                style="background:var(--gray); color:white; font-size:0.7em">Limpar</button>
        </div>
        <div id="historicoLista"></div>
    </div>

    <script>
        let jogadores = JSON.parse(localStorage.getItem('poker_jogadores')) || [];
        let historico = JSON.parse(localStorage.getItem('poker_historico')) || [];
        let startTimePartida = localStorage.getItem('poker_startTime') ? new Date(localStorage.getItem('poker_startTime')) : null;

        // ÁUDIO CONTEXT (Crucial para Mobile)
        let audioCtx = null;

        const timersData = {
            t10: { timeLeft: 600, interval: null, running: false, alarm: null },
            t7: { timeLeft: 420, interval: null, running: false, alarm: null },
            t2: { timeLeft: 120, interval: null, running: false, alarm: null }
        };

        window.onload = () => { render(); renderHistorico(); };

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                // Toca um silêncio rápido para desbloquear o áudio no iOS/Android
                const buffer = audioCtx.createBuffer(1, 1, 22050);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0);
            }
        }

        function playBeep() {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime); // Frequência mais alta para ouvir melhor
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3); // Beep curto
        }

        function saveToLocal() {
            localStorage.setItem('poker_jogadores', JSON.stringify(jogadores));
            localStorage.setItem('poker_historico', JSON.stringify(historico));
            if (startTimePartida) localStorage.setItem('poker_startTime', startTimePartida.toISOString());
            else localStorage.removeItem('poker_startTime');
        }

        function toggleTimer(id, initialSecs) {
            initAudio(); // Ativa o áudio no primeiro clique do usuário
            const t = timersData[id];
            const card = document.getElementById(id);

            if (!startTimePartida) { startTimePartida = new Date(); saveToLocal(); render(); }

            if (t.running) {
                clearInterval(t.interval);
                t.running = false;
            } else {
                if (t.timeLeft <= 0) return;
                t.running = true;
                t.interval = setInterval(() => {
                    if (t.timeLeft > 0) {
                        t.timeLeft--;
                        updateTimerDisplay(id);
                    } else {
                        clearInterval(t.interval);
                        t.running = false;
                        card.classList.add('alarm-active');
                        t.alarm = setInterval(playBeep, 1000);
                    }
                }, 1000);
            }
            render();
        }

        function resetIndividual(id, secs) {
            const t = timersData[id];
            clearInterval(t.interval);
            clearInterval(t.alarm);
            document.getElementById(id).classList.remove('alarm-active');
            t.running = false; t.timeLeft = secs;
            updateTimerDisplay(id);
            render();
        }

        function updateTimerDisplay(id) {
            const t = timersData[id];
            let m = Math.floor(t.timeLeft / 60), s = t.timeLeft % 60;
            document.querySelector(`#${id} .timer-display`).innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // --- LÓGICA DE JOGADORES ---
        function add() {
            const input = document.getElementById('nomeInput');
            if (input.value.trim()) {
                jogadores.push({ nome: input.value.trim(), qtd: 0 });
                input.value = ''; render(); saveToLocal();
            }
        }

        function change(index, delta) {
            jogadores[index].qtd = Math.max(0, jogadores[index].qtd + delta);
            render(); saveToLocal();
        }

        function remove(index) {
            const emAndamento = Object.values(timersData).some(t => t.running) || startTimePartida;
            if (emAndamento) return alert("Partida em curso!");
            if (confirm("Remover?")) { jogadores.splice(index, 1); render(); saveToLocal(); }
        }

        function render() {
            const lista = document.getElementById('lista');
            const calcAtual = document.getElementById('calculoAtual');
            const emAndamento = Object.values(timersData).some(t => t.running) || startTimePartida;
            lista.innerHTML = '';
            let total = 0;
            jogadores.forEach((j, i) => {
                total += j.qtd;
                lista.innerHTML += `<li><span>${j.nome}</span>
                <div class="controls">
                    <button class="btn-minus" onclick="change(${i}, -1)">-</button>
                    <span class="qty">${j.qtd}</span>
                    <button class="btn-plus" onclick="change(${i}, 1)">+</button>
                    <button class="btn-remove" ${emAndamento ? 'disabled' : ''} onclick="remove(${i})">X</button>
                </div></li>`;
            });
            document.getElementById('totalTxt').innerText = total;
            calcAtual.style.display = jogadores.length > 0 ? 'block' : 'none';
            if (total > 0) {
                let pos = [0], saldo = total;
                let inicial = Math.min(4, saldo); pos[0] = inicial; saldo -= inicial;
                while (saldo > 0) {
                    let u = pos.length - 1;
                    if (pos[u] >= (pos.length === 1 ? 0 : 3)) { pos.push(1); saldo--; if (saldo <= 0) break; }
                    for (let i = 0; i < pos.length; i++) {
                        if (i === pos.length - 1 && pos[i] >= 3 && pos.length > 1) continue;
                        if (saldo > 0) { pos[i]++; saldo--; }
                    }
                }
                const d = document.getElementById('dist');
                d.innerHTML = '';
                pos.forEach((v, i) => d.innerHTML += `<div class="result-box"><span>${i + 1}º Lugar</span><strong>${v} fichas</strong></div>`);
            }
        }

        function finalizarPartida() {
            const total = jogadores.reduce((acc, curr) => acc + curr.qtd, 0);
            if (total === 0) return;
            const endTime = new Date();
            const durationMs = startTimePartida ? (endTime - startTimePartida) : 0;
            const diffHrs = Math.floor(durationMs / 3600000), diffMins = Math.floor((durationMs % 3600000) / 60000);
            historico.unshift({
                inicio: startTimePartida ? startTimePartida.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '--:--',
                fim: endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                duracao: diffHrs > 0 ? `${diffHrs}h ${diffMins}m` : `${diffMins} min`,
                total: total
            });
            jogadores.forEach(j => j.qtd = 0);
            startTimePartida = null;
            Object.keys(timersData).forEach(id => resetIndividual(id, id === 't10' ? 600 : (id === 't7' ? 420 : 120)));
            render(); renderHistorico(); saveToLocal();
        }

        function renderHistorico() {
            const section = document.getElementById('historicoSection');
            const listaH = document.getElementById('historicoLista');
            if (historico.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block'; listaH.innerHTML = '';
            historico.forEach((p, i) => {
                listaH.innerHTML += `
                <div class="history-card">
                    <b>Partida #${historico.length - i}</b> - Total: ${p.total}<br>
                    <small>⏱ ${p.inicio} às ${p.fim} (${p.duracao})</small>
                </div>`;
            });
        }

        function limparHistorico() { if (confirm("Limpar?")) { historico = []; saveToLocal(); renderHistorico(); } }
    </script>
</body>

</html>
